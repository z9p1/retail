# 店家线上零售系统 — 业务需求分析

## 一、项目概述

本系统是一个面向**单店家**的轻量级线上零售系统，支持店家管理商品与库存、用户在线购买、以及基于流量与用户维度的经营分析。技术栈为 **Java + Spring Boot + Vue3 + MySQL + Redis**，当前环境为本地开发部署。

**本系统为单店铺系统，不支持：**

- 多商户入驻
- 优惠券系统
- 退款售后
- 物流系统对接
- 第三方支付接入

---

## 二、业务角色与核心场景

| 角色 | 描述 | 核心诉求 |
|------|------|----------|
| **店家** | 店铺运营方，管理商品与查看经营数据 | 上/下架商品、维护库存、监控流量、分析用户消费 |
| **用户** | 终端消费者 | 浏览商品、下单购买、查看订单 |

### 2.1 角色与权限矩阵规划

| 功能/资源 | 店家 | 用户 | 说明 |
|-----------|:----:|:----:|------|
| 工作台概览 | ✓ | — | 仅店家可见 |
| 商品管理（上下架、库存、新增） | ✓ | — | 仅店家 |
| 商品列表（全部/含下架） | ✓ | — | 店家看全部 |
| 商品浏览（在售） | — | ✓ | 用户仅看在售 |
| 购物车、下单、支付（模拟） | — | ✓ | 仅用户 |
| 我的订单（本人） | — | ✓ | 仅用户本人 |
| 订单管理（全部订单、发货） | ✓ | — | 仅店家 |
| 流量监控 | ✓ | — | 仅店家 |
| 用户消费分析 | ✓ | — | 仅店家，按用户查询 |
| 个人设置、修改密码、退出 | ✓ | ✓ | 各自仅操作本人 |

**权限实现**：后端按角色（店家/用户）校验接口，越权返回 403；前端按角色渲染菜单与按钮；用户分析、流量监控仅店家角色可访问。

---

## 三、菜单与页面结构（店家端与用户端）

### 3.1 店家端可操作菜单及内容

| 一级菜单 | 菜单说明 | 页面/具体内容 |
|----------|----------|----------------|
| **工作台** | 首页概览 | 今日/本周关键指标卡片（订单数、销售额、访客数）；快捷入口（待处理订单、低库存提醒）。 |
| **商品管理** | 商品与库存 | **商品列表**：表格展示全部商品（名称、价格、库存、上下架状态、操作）；**上架/下架**：单条上架/下架、批量下架；**编辑库存**：弹窗或行内修改数量；**新增商品**：表单（名称、价格、初始库存、描述、图片等）提交上架。 |
| **订单管理** | 店家视角订单 | **订单列表**：按状态筛选（待发货/已发货/已完成/已取消）、按时间范围查询；表格字段：订单号、用户、金额、状态、下单时间、操作（发货、查看详情）；**订单详情**：订单基本信息 + 商品明细 + 用户信息 + 状态流转记录。 |
| **流量监控** | 最近购物流量 | **时间筛选**：今日 / 最近 7 天 / 最近 30 天；**概览卡片**：UV、PV、下单笔数、下单人数、成交金额；**趋势图**：按天或按小时的访问量/订单量/金额折线图或柱状图；**按天汇总表**：按天汇总的明细列表。 |
| **用户分析** | 单用户消费分析 | **用户查询**：按用户 ID、手机号或昵称搜索；**消费汇总**：该用户总订单数、总消费金额、首次/最近购买时间；**订单明细列表**：该用户历史订单（时间、订单号、金额、状态）；**商品偏好**：该用户购买过的商品及数量、金额排行。 |
| **个人/设置** | 账号与系统 | 当前登录店家信息、修改密码、退出登录；店铺名称、联系方式等基础设置。 |

---

### 3.2 用户端可操作菜单及内容

| 一级菜单 | 菜单说明 | 页面/具体内容 |
|----------|----------|----------------|
| **首页/商城** | 商品浏览与购买入口 | **商品列表**：仅展示上架且库存 > 0 的商品（卡片或列表：图、名称、价格、库存状态）；**搜索/筛选**：按名称搜索、按价格排序；**商品详情**：大图、名称、价格、库存、描述、加入购物车、立即购买。 |
| **购物车** | 待结算商品 | 购物车列表：商品图、名称、单价、数量（可改）、小计、删除；全选、总价、去结算；“立即购买”从商品详情直达确认页。 |
| **订单** | 用户本人订单 | **订单列表**：全部/待支付/待发货/已发货/已完成/已取消 Tab；每单展示：订单号、商品摘要、总金额、状态、下单时间、操作（去支付、取消、确认收货、查看详情）；**订单详情**：订单信息 + 商品明细 + 物流/状态。 |
| **我的** | 个人中心 | 当前用户信息（昵称、手机号等）；**我的订单**：跳转订单列表；**收货地址**：地址列表与编辑；修改密码、退出登录。 |

---

### 3.3 菜单与功能的对应关系

| 需求功能（见第四节） | 店家端菜单 | 用户端菜单 |
|----------------------|------------|------------|
| 商品上架/下架与数量管理 | 商品管理 | — |
| 用户购买 | 订单管理（查看） | 首页/商城、购物车、订单 |
| 最近购物流量监控 | 流量监控 | — |
| 具体用户购物消费分析 | 用户分析 | — |

---

## 四、功能需求分析

### 4.1 店家：商品上架/下架与数量管理

**业务含义**：店家对在售商品进行上下架与库存数量维护。

| 需求项 | 说明 |
|--------|------|
| 上架商品 | 新增商品信息（名称、价格、库存、描述等），状态为“在售” |
| 下架商品 | 将商品设为“下架”，用户端不可见、不可购买 |
| 数量管理 | 修改在售商品的库存数量（增/减）；库存为 0 时保持上架状态，仅禁止购买 |
| 商品列表 | 店家可查看全部商品及当前上下架状态、库存 |

**边界与规则**：

- 下架后，该商品已有订单不受影响，仅影响新订单。
- 库存扣减在支付成功时执行，超卖防护采用数据库乐观锁（见 4.5）。

---

### 4.2 用户购买

**业务含义**：用户浏览在售商品、加入购物车或直接下单、完成购买流程。

| 需求项 | 说明 |
|--------|------|
| 商品浏览 | 仅展示“上架”且库存 > 0 的商品 |
| 加入购物车 | 支持购物车，选择数量并加入 |
| 下单 | 选择商品及数量，生成订单（待支付/待发货等状态） |
| 支付与库存 | 支付成功（或确认订单）后扣减库存；取消/超时则释放库存 |
| 订单查询 | 用户查看自己的订单列表与状态 |

**边界与规则**：

- 下单时仅校验库存与上下架状态，不扣减库存；支付成功时在事务内扣减库存（按 4.5 乐观锁执行）。
- 订单与商品、用户关联清晰，用于用户消费分析。

---

### 4.3 店家：最近购物流量监控

**业务含义**：店家对“最近一段时间”的访问与购买行为做流量级监控，用于感知热度与趋势。

| 需求项 | 说明 |
|--------|------|
| 时间范围 | 固定三种：今日、最近 7 天、最近 30 天 |
| 流量指标 | UV（独立访客）、PV（页面/接口访问量）、下单笔数、下单人数、成交金额 |
| 趋势展示 | 按天或按小时聚合展示访问量/订单量/金额趋势 |
| 数据来源 | 访问行为写入 Redis：UV 使用 HyperLogLog，按天/小时 key 聚合；PV 及下单数据写入 MySQL（订单表 + 访问日志表），统计时按时间范围聚合 |

**边界与规则**：

- 时间维度仅支持今日、最近 7 天、最近 30 天，不做可配置扩展。
- UV 使用 Redis HyperLogLog 统计；下单笔数、人数、金额从 MySQL 订单表按时间范围聚合；趋势数据按天或按小时从上述数据聚合得出。

---

### 4.4 店家：具体用户购物消费分析

**业务含义**：店家针对**单个用户**查看其在本店的购物与消费情况，用于复购与运营分析。

| 需求项 | 说明 |
|--------|------|
| 用户识别 | 按用户 ID 或手机号等唯一标识查询 |
| 消费汇总 | 该用户的总订单数、总金额、首次/最近购买时间等 |
| 订单明细 | 该用户的历史订单列表（时间、商品、数量、金额、状态） |
| 商品偏好 | 该用户购买过的商品及数量、金额排行 |
| 复购与频次 | 购买频次、间隔、是否高价值用户等简单标签 |

**边界与规则**：

- 仅店家端可查看，接口校验店家角色，否则返回 403。
- 数据从订单表按用户维度聚合；用户消费列表与汇总结果使用 Redis 缓存，缓存键含用户 ID，过期时间 5 分钟。

---

### 4.5 库存扣减策略说明

| 策略项 | 说明 |
|--------|------|
| **扣减时机** | 在「支付成功」时扣减库存；创建订单不扣减，仅支付（模拟支付）成功后在支付回调或支付接口内扣减。 |
| **预占** | 本系统不做下单预占；防超卖仅依赖支付时的数据库乐观锁扣减。 |
| **扣减顺序** | 在同一事务内：校验库存充足 → 执行 UPDATE 商品表 SET stock=stock-数量, version=version+1 WHERE id=? AND version=? → 更新订单状态为已支付、写订单明细；若 UPDATE 影响行数为 0 则回滚并返回库存不足。 |
| **超卖防护** | 采用数据库乐观锁：商品表增加 version 字段，扣减时 UPDATE ... WHERE id=? AND version=? AND stock>=?；影响行数为 0 表示并发冲突或库存不足，返回「库存不足」并回滚。 |
| **回滚场景** | 订单取消、支付超时关闭时，将已扣减库存加回：UPDATE 商品表 SET stock=stock+数量, version=version+1 WHERE id=?；按订单明细逐行回滚；接口幂等（订单号+操作类型），重复回滚返回已处理。 |
| **与上下架关系** | 扣减仅针对「上架」且库存>0 的商品；下架商品不参与扣减，已有订单中的商品若已下架不影响该订单。 |

---

## 五、状态流转图

### 5.1 订单状态流转

```
                    ┌─────────────┐
                    │   待支付    │
                    └──────┬──────┘
                           │ 支付成功
              ┌────────────┼────────────┐
              │ 取消/超时  │            │
              ▼            ▼            │
       ┌──────────┐  ┌─────────────┐    │
       │  已取消  │  │  待发货     │◄───┘
       └──────────┘  └──────┬──────┘
                            │ 店家发货
                            ▼
                     ┌─────────────┐
                     │  已发货     │
                     └──────┬──────┘
                            │ 用户确认收货
                            ▼
                     ┌─────────────┐
                     │  已完成     │
                     └─────────────┘
```

| 状态 | 说明 | 可执行操作（用户） | 可执行操作（店家） |
|------|------|--------------------|--------------------|
| 待支付 | 订单已创建，未支付 | 去支付、取消订单 | 查看 |
| 已取消 | 用户取消或超时未支付 | — | 查看 |
| 待发货 | 已支付，待店家发货 | 查看 | 发货 |
| 已发货 | 店家已发货 | 确认收货 | 查看 |
| 已完成 | 用户确认收货 | 查看 | 查看 |

### 5.2 商品状态流转

```
     ┌─────────────┐        上架          ┌─────────────┐
     │   下架     │ ──────────────────► │   在售      │
     └─────────────┘                     └──────┬──────┘
            ▲                                   │ 下架
            └───────────────────────────────────┘
```

- **在售**：用户可见、可购买；库存为 0 时保持上架状态，仅禁止购买。
- **下架**：用户不可见、不可购买；店家可随时重新上架。

---

## 六、异常处理需求

| 类型 | 场景 | 处理要求 |
|------|------|----------|
| **业务校验** | 库存不足、商品已下架、订单状态不允许操作（如待支付不能发货） | 返回明确业务错误码与提示文案，HTTP 4xx；前端展示友好提示，不抛未捕获异常。 |
| **幂等** | 重复支付、重复取消、重复发货 | 接口设计幂等（如订单号+操作类型）；重复请求返回「已处理」或当前状态，不重复扣减/回滚库存。 |
| **并发** | 同一商品多笔订单同时扣减库存 | 按 4.5 采用数据库乐观锁扣减，UPDATE 影响行数为 0 时返回「库存不足」，前端提示重试。 |
| **会话/权限** | 未登录、Token 过期、越权访问（如用户访问店家接口） | 统一返回 401/403，前端跳转登录或提示无权限。 |
| **系统异常** | 数据库/Redis 不可用、超时、未知异常 | 记录日志；对用户返回通用「系统繁忙，请稍后重试」，HTTP 500；避免向前端暴露堆栈与内部信息。 |
| **参数校验** | 缺少必填项、格式错误、数量≤0 | 请求体校验（如 JSR-303），返回 400 与字段级错误信息。 |

**统一响应约定**：响应体包含 `code`（业务码）、`message`（提示）、`data`（载荷）；成功时 HTTP 2xx 且 `code` 为约定成功码（如 0），错误时 HTTP 4xx/5xx 且 `code` 为具体错误码，前端按 `code` 统一处理。

---

## 七、非功能需求（简要）

| 类型 | 说明 |
|------|------|
| 性能 | 库存扣减采用数据库乐观锁（见 4.5），不做 Redis 预扣；本地环境仅 MySQL 内事务保证一致性。 |
| 安全 | 登录与鉴权采用 JWT；按角色（店家/用户）校验接口，店家接口仅店家 Token 可访问，越权返回 403。 |
| 数据 | MySQL 存商品、订单、用户、访问日志等主数据；Redis 用于：热点数据缓存、UV 统计（HyperLogLog）、用户分析/流量监控结果缓存。库存扣减在 MySQL 内完成，不使用 Redis。 |
| 部署 | 当前为本地：MySQL/Redis 本机，后端 Spring Boot，前端 Vue3 开发态访问 |

---

## 八、技术栈与模块划分（概要）

| 层次 | 技术选型 | 说明 |
|------|----------|------|
| 后端 | Java 8 (1.8) / Spring Boot 2.x | REST API、业务逻辑、事务与安全 |
| 数据访问 | MyBatis-Plus + MySQL | 商品、订单、用户、访问日志表；商品表含 version 字段用于乐观锁。 |
| 缓存与辅助 | Redis | UV 统计（HyperLogLog）、用户分析/流量监控结果缓存；不参与库存扣减。 |
| 前端 | Vue 3 + (Pinia/Vue Router) + Axios | 店家端与用户端页面 |
| 接口风格 | RESTful | 统一响应格式与错误码 |

**模块划分**：

- **商品模块**：上下架、库存、列表（店家看全部，用户仅看在售）
- **订单模块**：创建、支付、取消、状态流转、库存回滚（乐观锁）
- **用户模块**：注册/登录、JWT 会话、角色校验（店家/用户）
- **统计模块**：流量监控（UV/PV/下单从 Redis+MySQL 聚合）、单用户消费分析（订单表聚合+Redis 缓存）

---

## 九、核心数据实体（概念级）

- **商品**：id, 名称, 价格, 库存, 上下架状态, 创建/更新时间  
- **用户**：id, 账号, 密码(加密), 角色(店家/用户), 手机号等  
- **订单**：id, 用户id, 总金额, 状态, 创建/支付时间  
- **订单明细**：id, 订单id, 商品id, 数量, 单价, 小计  
- **访问/行为日志**：id, 用户id, 类型(浏览/下单), 时间, 关联id；用于流量监控 UV/PV 及趋势统计。  

流量监控依赖访问/行为日志与订单表聚合；用户消费分析依赖订单表按用户维度聚合。

---

## 十、后续实施顺序

1. 搭建工程：Spring Boot 2.x + Vue3 脚手架，MySQL/Redis 配置与基础表结构（含商品 version、访问日志表）。  
2. 实现用户与权限：登录、JWT 签发与校验、店家/用户角色与 403 越权拦截。  
3. 实现商品与库存：上下架、数量管理、列表接口（店家全部/用户在售）。  
4. 实现下单与订单：下单（仅校验库存）、支付接口（事务内乐观锁扣减）、取消/超时回滚库存。  
5. 实现流量监控：访问埋点写 Redis（UV HyperLogLog）/MySQL（日志表），按今日/7 天/30 天聚合，前端看板。  
6. 实现用户消费分析：按用户查询订单与汇总、商品偏好与复购统计；结果 Redis 缓存 5 分钟。  
7. 前端联调与本地联测。

---

## 十一、文档与仓库说明

- 本文档为**业务需求分析**，作为开发与评审依据。  
- 接口定义、表结构设计可在后续的 `API.md`、`DB.md` 或项目 Wiki 中维护。  
- 当前为本地环境，生产部署时需补充环境变量、Redis/MySQL 高可用与备份策略。

---

*文档版本：v1.2 | 适用于：Java + Spring + Vue3 + MySQL + Redis 本地零售系统*
